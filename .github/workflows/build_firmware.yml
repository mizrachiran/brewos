# Build and test firmware on PRs
# Note: Push to main is handled by dev-release.yml which creates the dev release
name: "PR: Pico Firmware Build & Test"

on:
  pull_request:
    branches: ["main"]
    paths:
      - "src/pico/**"
      - "src/esp32/**"
      - "src/web/**"
      - "src/shared/**"
  workflow_dispatch:

# Cancel in-progress runs for the same PR
concurrency:
  group: build-firmware-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # ==========================================================================
  # Pico Unit Tests (runs first, blocks build on failure)
  # ==========================================================================
  test-pico:
    name: Pico Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake

      - name: Build Tests
        run: |
          cd src/pico/test
          mkdir -p build && cd build
          cmake ..
          make -j$(nproc)

      - name: Run Tests
        run: |
          cd src/pico/test/build
          ./brewos_tests

      - name: Test Summary
        if: always()
        run: |
          echo "=== Pico Unit Tests Complete ==="

  # ==========================================================================
  # Pico Firmware Build
  # ==========================================================================
  build-pico:
    name: Build Pico Firmware
    runs-on: ubuntu-latest
    needs: test-pico # Run tests before building

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install ARM GCC Toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-arm-none-eabi libnewlib-arm-none-eabi build-essential cmake

      - name: Clone Pico SDK
        run: |
          git clone https://github.com/raspberrypi/pico-sdk.git ~/pico-sdk
          cd ~/pico-sdk
          git submodule update --init

      - name: Build All Machine Types
        env:
          PICO_SDK_PATH: ~/pico-sdk
        run: |
          cd src/pico
          mkdir build && cd build
          cmake -DBUILD_ALL_MACHINES=ON ..
          make -j$(nproc)

      - name: Verify Build Output
        run: |
          cd src/pico/build
          echo "=== Built Firmware Files ==="
          ls -lh *.uf2
          echo ""
          echo "=== Verification ==="
          test -f brewos_dual_boiler.uf2 && echo "✓ brewos_dual_boiler.uf2" || (echo "✗ Missing dual_boiler" && exit 1)
          test -f brewos_single_boiler.uf2 && echo "✓ brewos_single_boiler.uf2" || (echo "✗ Missing single_boiler" && exit 1)
          test -f brewos_heat_exchanger.uf2 && echo "✓ brewos_heat_exchanger.uf2" || (echo "✗ Missing heat_exchanger" && exit 1)
          echo ""
          echo "All 3 machine types built successfully!"

      - name: Upload Dual Boiler Firmware
        uses: actions/upload-artifact@v5
        with:
          name: brewos-dual-boiler
          path: src/pico/build/brewos_dual_boiler.uf2
          retention-days: 30

      - name: Upload Single Boiler Firmware
        uses: actions/upload-artifact@v5
        with:
          name: brewos-single-boiler
          path: src/pico/build/brewos_single_boiler.uf2
          retention-days: 30

      - name: Upload Heat Exchanger Firmware
        uses: actions/upload-artifact@v5
        with:
          name: brewos-heat-exchanger
          path: src/pico/build/brewos_heat_exchanger.uf2
          retention-days: 30

  # Note: ESP32 firmware build is handled by ci.yml workflow
  # which includes change detection to only run when ESP32 files change
