# Build firmware on push and PR
name: Build Firmware

on:
  push:
    branches: ["main"]
    paths:
      - 'src/pico/**'
      - 'src/esp32/**'
      - 'src/web/**'
      - 'src/shared/**'
      - '.github/workflows/build_firmware.yml'
  pull_request:
    branches: ["main"]
    paths:
      - 'src/pico/**'
      - 'src/esp32/**'
      - 'src/web/**'
      - 'src/shared/**'
  workflow_dispatch:

jobs:
  build-pico:
    name: Build Pico Firmware
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ARM GCC Toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-arm-none-eabi libnewlib-arm-none-eabi build-essential cmake

      - name: Clone Pico SDK
        run: |
          git clone https://github.com/raspberrypi/pico-sdk.git ~/pico-sdk
          cd ~/pico-sdk
          git submodule update --init

      - name: Build All Machine Types
        env:
          PICO_SDK_PATH: ~/pico-sdk
        run: |
          cd src/pico
          mkdir build && cd build
          cmake -DBUILD_ALL_MACHINES=ON ..
          make -j$(nproc)

      - name: Verify Build Output
        run: |
          cd src/pico/build
          echo "=== Built Firmware Files ==="
          ls -lh *.uf2
          echo ""
          echo "=== Verification ==="
          test -f brewos_dual_boiler.uf2 && echo "✓ brewos_dual_boiler.uf2" || (echo "✗ Missing dual_boiler" && exit 1)
          test -f brewos_single_boiler.uf2 && echo "✓ brewos_single_boiler.uf2" || (echo "✗ Missing single_boiler" && exit 1)
          test -f brewos_heat_exchanger.uf2 && echo "✓ brewos_heat_exchanger.uf2" || (echo "✗ Missing heat_exchanger" && exit 1)
          echo ""
          echo "All 3 machine types built successfully!"

      - name: Upload Dual Boiler Firmware
        uses: actions/upload-artifact@v4
        with:
          name: brewos-dual-boiler
          path: src/pico/build/brewos_dual_boiler.uf2
          retention-days: 30

      - name: Upload Single Boiler Firmware
        uses: actions/upload-artifact@v4
        with:
          name: brewos-single-boiler
          path: src/pico/build/brewos_single_boiler.uf2
          retention-days: 30

      - name: Upload Heat Exchanger Firmware
        uses: actions/upload-artifact@v4
        with:
          name: brewos-heat-exchanger
          path: src/pico/build/brewos_heat_exchanger.uf2
          retention-days: 30

  build-esp32:
    name: Build ESP32 Firmware
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: src/web/package-lock.json

      - name: Build Web UI for ESP32
        run: |
          cd src/web
          npm ci
          npm run build:esp32
          echo "=== Web UI Built ==="
          ls -lah ../esp32/data/
          du -sh ../esp32/data/

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PlatformIO
        run: pip install platformio

      - name: Build ESP32 Firmware
        run: |
          cd src/esp32
          pio run -e esp32s3

      - name: Build LittleFS Image
        run: |
          cd src/esp32
          pio run -e esp32s3 -t buildfs

      - name: Verify Build Output
        run: |
          echo "=== Built Firmware Files ==="
          ls -lh src/esp32/.pio/build/esp32s3/firmware.*
          ls -lh src/esp32/.pio/build/esp32s3/littlefs.bin || true
          echo ""
          test -f src/esp32/.pio/build/esp32s3/firmware.bin && echo "✓ ESP32 firmware.bin built successfully!"
          test -f src/esp32/.pio/build/esp32s3/littlefs.bin && echo "✓ LittleFS image built successfully!"

      - name: Upload ESP32 Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: esp32-firmware
          path: |
            src/esp32/.pio/build/esp32s3/firmware.bin
            src/esp32/.pio/build/esp32s3/littlefs.bin
          retention-days: 30
