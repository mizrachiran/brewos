# Build and publish dev firmware on every push to main
# Creates/updates a rolling "dev-latest" prerelease for development testing
name: "Main â†’ Dev Firmware Release"

on:
  push:
    branches: [main]
    paths:
      - "src/esp32/**"
      - "src/pico/**"
      - "src/web/**"
      - "src/shared/**"

# Only allow one dev release at a time - cancel older runs
concurrency:
  group: dev-release
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build-dev:
    name: Build Dev Firmware
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      # ===== Pico Unit Tests =====
      - name: Run Pico Unit Tests
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake
          cd src/pico/test
          mkdir -p build && cd build
          cmake ..
          make -j$(nproc)
          ./brewos_tests

      # ===== Pico Build =====
      - name: Install ARM GCC Toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-arm-none-eabi libnewlib-arm-none-eabi build-essential cmake

      - name: Clone Pico SDK
        run: |
          git clone https://github.com/raspberrypi/pico-sdk.git ~/pico-sdk
          cd ~/pico-sdk
          git submodule update --init

      - name: Build Pico Firmware
        env:
          PICO_SDK_PATH: ~/pico-sdk
        run: |
          cd src/pico
          mkdir build && cd build
          cmake -DBUILD_ALL_MACHINES=ON -DCMAKE_BUILD_TYPE=Release ..
          make -j$(nproc)

      # ===== Web UI Build for ESP32 =====
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: src/web/package-lock.json

      - name: Build Web UI for ESP32
        run: |
          cd src/web
          npm ci
          npm run build:esp32

      # ===== ESP32 Firmware Build =====
      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Install PlatformIO
        run: pip install platformio

      - name: Build ESP32 Firmware
        run: |
          cd src/esp32
          pio run -e esp32s3

      - name: Build LittleFS Image
        run: |
          cd src/esp32
          pio run -e esp32s3 -t buildfs

      # ===== Prepare Release Assets =====
      - name: Prepare Release Files
        run: |
          mkdir -p release

          # Copy Pico firmware
          cp src/pico/build/brewos_dual_boiler.uf2 release/
          cp src/pico/build/brewos_single_boiler.uf2 release/
          cp src/pico/build/brewos_heat_exchanger.uf2 release/

          # Copy ESP32 firmware
          cp src/esp32/.pio/build/esp32s3/firmware.bin release/brewos_esp32.bin
          cp src/esp32/.pio/build/esp32s3/littlefs.bin release/brewos_esp32_littlefs.bin

          # Create checksums
          cd release
          sha256sum *.uf2 *.bin > SHA256SUMS.txt

      - name: Get Short SHA
        id: sha
        run: echo "short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      # Create or update dev-latest release using GitHub CLI
      # This is more reliable than delete + recreate which can leave orphaned releases
      - name: Update Dev Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_NAME="ðŸ”§ Dev Build (${{ steps.sha.outputs.short }})"
          RELEASE_NOTES=$(cat <<'EOF'
          ## Development Build

          âš ï¸ **This is an automated dev build from the `main` branch.**

          **Commit:** ${{ github.sha }}
          **Built:** ${{ github.event.head_commit.timestamp }}

          ### How to Use

          1. Go to your ESP32's local web UI (e.g., `http://brewos.local`)
          2. Navigate to **Settings â†’ System â†’ Firmware Update**
          3. Select **Dev** channel
          4. Download and flash the firmware

          ### Changes

          ${{ github.event.head_commit.message }}

          ---

          ðŸ”„ This release is automatically replaced on every push to `main`.
          EOF
          )

          # Check if release exists
          if gh release view dev-latest &>/dev/null; then
            echo "Updating existing dev-latest release..."
            
            # Update release metadata
            gh release edit dev-latest \
              --title "$RELEASE_NAME" \
              --notes "$RELEASE_NOTES" \
              --prerelease
            
            # Upload assets with --clobber to replace existing files
            gh release upload dev-latest \
              release/brewos_dual_boiler.uf2 \
              release/brewos_single_boiler.uf2 \
              release/brewos_heat_exchanger.uf2 \
              release/brewos_esp32.bin \
              release/brewos_esp32_littlefs.bin \
              release/SHA256SUMS.txt \
              --clobber
          else
            echo "Creating new dev-latest release..."
            gh release create dev-latest \
              --title "$RELEASE_NAME" \
              --notes "$RELEASE_NOTES" \
              --prerelease \
              --target main \
              release/brewos_dual_boiler.uf2 \
              release/brewos_single_boiler.uf2 \
              release/brewos_heat_exchanger.uf2 \
              release/brewos_esp32.bin \
              release/brewos_esp32_littlefs.bin \
              release/SHA256SUMS.txt
          fi
